#!/bin/bash
# ==============================================================================
#      MAUTIC DEPLOYMENT SCRIPT FOR SELECTEL (VSCALE.IO API)
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
# 1. –†–∞–±–æ—Ç–∞–µ—Ç —Å API Selectel –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–ø–æ–∏—Å–∫–∞ SSH-–∫–ª—é—á–∞.
# 2. –°–æ–∑–¥–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä (scalet), –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
# 3. –û–∂–∏–¥–∞–µ—Ç –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–ª—É—á–∞–µ—Ç –µ–≥–æ IP-–∞–¥—Ä–µ—Å.
# 4. –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–≤–∏—á–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ—Ä–≤–µ—Ä–∞ (–∞–Ω–∞–ª–æ–≥ user-data).
# 5. –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç Deno-—Å–∫—Ä–∏–ø—Ç –∏ –∫–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
# 6. –ó–∞–ø—É—Å–∫–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Mautic —Å Docker Compose.
# 7. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –ø—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –≤—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
# ==============================================================================

set -e

echo "üöÄ Starting deployment to Selectel..."

# --- –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø SELECTEL ---
# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Selectel API ---
SELECTEL_API_URL="https://api.vscale.io/v1"
SELECTEL_TOKEN="${INPUT_SELECTEL_TOKEN}" # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π input –¥–ª—è —Ç–æ–∫–µ–Ω–∞

# Set default port if not provided
MAUTIC_PORT=${INPUT_MAUTIC_PORT:-8001}

echo "üìù Configuration:"
echo "  VPS Name: ${INPUT_VPS_NAME}"
echo "  VPS Plan: ${INPUT_VPS_RPLAN}"
echo "  VPS Location: ${INPUT_VPS_LOCATION}"
echo "  Mautic Version: ${INPUT_MAUTIC_VERSION}"
echo "  Email: ${INPUT_EMAIL}"
echo "  Domain: ${INPUT_DOMAIN:-'Not set (will use IP)'}"

# --- –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SSH –∫–ª—é—á–µ–π ---
echo "üîê Setting up SSH authentication..."
mkdir -p ~/.ssh
echo "${INPUT_SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
chmod 600 ~/.ssh/id_rsa

echo "üîë Generating public key from private key..."
if ! ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub 2>/dev/null; then
    echo "‚ùå Error: Failed to generate public key from private key"
    exit 1
fi
SSH_PUBLIC_KEY_CONTENT=$(cat ~/.ssh/id_rsa.pub)
KEY_NAME="mautic-deploy-key-$(date +%s)"

echo "üîç Finding or creating SSH key in Selectel account..."

# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ –∏–∑ Selectel
ALL_KEYS_JSON=$(curl -s -X GET "${SELECTEL_API_URL}/sshkeys" -H "X-Token: ${SELECTEL_TOKEN}")

# –ò—â–µ–º –Ω–∞—à –∫–ª—é—á –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É. –ò—Å–ø–æ–ª—å–∑—É–µ–º jq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON.
# `jq` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –æ–±—Ä–∞–∑–µ runner'–∞ (–≤ `ubuntu-latest` –æ–Ω –µ—Å—Ç—å)
SSH_KEY_ID=$(echo "${ALL_KEYS_JSON}" | jq -r --arg key "${SSH_PUBLIC_KEY_CONTENT}" '.[] | select(.key == $key) | .id')

if [ -z "$SSH_KEY_ID" ] || [ "$SSH_KEY_ID" == "null" ]; then
    echo "üîë Key not found. Adding a new key to Selectel..."
    ADD_KEY_PAYLOAD=$(jq -n --arg name "$KEY_NAME" --arg key "$SSH_PUBLIC_KEY_CONTENT" '{name: $name, key: $key}')
    
    NEW_KEY_JSON=$(curl -s -X POST "${SELECTEL_API_URL}/sshkeys" \
        -H "Content-Type: application/json;charset=UTF-8" \
        -H "X-Token: ${SELECTEL_TOKEN}" \
        -d "${ADD_KEY_PAYLOAD}")
    
    SSH_KEY_ID=$(echo "${NEW_KEY_JSON}" | jq -r '.id')
    
    if [ -z "$SSH_KEY_ID" ] || [ "$SSH_KEY_ID" == "null" ]; then
        echo "‚ùå Error: Failed to add SSH key to Selectel account."
        echo "Response: ${NEW_KEY_JSON}"
        exit 1
    fi
    echo "‚úÖ New SSH key added to Selectel (ID: ${SSH_KEY_ID}, Name: ${KEY_NAME})"
else
    echo "‚úÖ Found existing SSH key in Selectel (ID: ${SSH_KEY_ID})"
fi


# --- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç) ---
echo "üñ•Ô∏è  Checking if VPS '${INPUT_VPS_NAME}' exists..."
# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
ALL_SERVERS_JSON=$(curl -s -X GET "${SELECTEL_API_URL}/scalets" -H "X-Token: ${SELECTEL_TOKEN}")
SERVER_EXISTS_CTID=$(echo "${ALL_SERVERS_JSON}" | jq -r --arg name "${INPUT_VPS_NAME}" '.[] | select(.name == $name) | .ctid')

if [ -z "$SERVER_EXISTS_CTID" ] || [ "$SERVER_EXISTS_CTID" == "null" ]; then
    echo "üì¶ Creating new VPS '${INPUT_VPS_NAME}'..."
    # –í–ê–ñ–ù–û: –£–∫–∞–∂–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π ID –æ–±—Ä–∞–∑–∞ (make_from). –ù–∞–ø—Ä–∏–º–µ—Ä, —Å Ubuntu 22.04 + Docker.
    # –≠—Ç–æ—Ç ID –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–ª–∏ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Selectel.
    # –ü—Ä–∏–º–µ—Ä: ubuntu_22.04_64_docker_latest
    IMAGE_ID="ubuntu_22.04_64_001_master" 
    echo "üîß Using image ID: ${IMAGE_ID}"

    CREATE_SERVER_PAYLOAD=$(jq -n \
        --arg make_from "$IMAGE_ID" \
        --arg rplan "${INPUT_VPS_RPLAN}" \
        --arg name "${INPUT_VPS_NAME}" \
        --argjson keys "[$SSH_KEY_ID]" \
        --arg location "${INPUT_VPS_LOCATION}" \
        '{make_from: $make_from, rplan: $rplan, do_start: true, name: $name, keys: $keys, location: $location}')

    CREATED_SERVER_JSON=$(curl -s -X POST "${SELECTEL_API_URL}/scalets" \
        -H "Content-Type: application/json;charset=UTF-8" \
        -H "X-Token: ${SELECTEL_TOKEN}" \
        -d "${CREATE_SERVER_PAYLOAD}")

    SERVER_CTID=$(echo "${CREATED_SERVER_JSON}" | jq -r '.ctid')

    if [ -z "$SERVER_CTID" ] || [ "$SERVER_CTID" == "null" ]; then
        echo "‚ùå Error: Failed to create VPS in Selectel."
        echo "Response: ${CREATED_SERVER_JSON}"
        exit 1
    fi
     echo "‚úÖ VPS creation initiated (CTID: ${SERVER_CTID}). Waiting for it to become active..."
else
    echo "‚úÖ VPS '${INPUT_VPS_NAME}' already exists. CTID: ${SERVER_EXISTS_CTID}"
    SERVER_CTID=$SERVER_EXISTS_CTID
fi

# --- –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ ---
echo "üîç Getting VPS IP address for CTID: ${SERVER_CTID}..."
VPS_IP=""
TIMEOUT=300 # 5 –º–∏–Ω—É—Ç
COUNTER=0
while [ -z "$VPS_IP" ]; do
    if [ $COUNTER -ge $TIMEOUT ]; then
        echo "‚ùå Timeout: Could not get VPS IP address after ${TIMEOUT} seconds."
        exit 1
    fi

    SERVER_DETAILS_JSON=$(curl -s -X GET "${SELECTEL_API_URL}/scalets/${SERVER_CTID}" -H "X-Token: ${SELECTEL_TOKEN}")
    SERVER_STATUS=$(echo "${SERVER_DETAILS_JSON}" | jq -r '.status')
    
    if [ "$SERVER_STATUS" = "started" ]; then
        VPS_IP=$(echo "${SERVER_DETAILS_JSON}" | jq -r '.public_address.address')
        if [ -n "$VPS_IP" ] && [ "$VPS_IP" != "null" ]; then
             echo "‚úÖ VPS is active. IP address: $VPS_IP"
             break
        fi
    fi
    echo "‚è≥ Waiting for VPS to be ready... (Status: ${SERVER_STATUS}, ${COUNTER}/${TIMEOUT}s)"
    sleep 10
    COUNTER=$((COUNTER + 10))
done

# --- –®–∞–≥ 4: –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–∞–Ω–∞–ª–æ–≥ user-data) ---
echo "üîß Running initial server setup (installing Docker, Nginx, etc.)..."
echo "üîê Waiting for SSH to be available..."
SSH_TIMEOUT=300
SSH_COUNTER=0
while ! nc -z "$VPS_IP" 22; do
    if [ $SSH_COUNTER -ge $SSH_TIMEOUT ]; then
        echo "‚ùå SSH connection timeout after ${SSH_TIMEOUT} seconds"
        exit 1
    fi
    echo "‚è≥ Waiting for SSH... (${SSH_COUNTER}/${SSH_TIMEOUT}s)"
    sleep 10
    SSH_COUNTER=$((SSH_COUNTER + 10))
done
echo "‚úÖ SSH is available"

# –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç setup-vps.sh –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i ~/.ssh/id_rsa root@${VPS_IP} 'bash -s' < "${ACTION_PATH}/scripts/setup-vps.sh"
echo "‚úÖ Initial server setup complete."
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –î–õ–Ø SELECTEL ---


# --- –ë–õ–û–ö –û–°–¢–ê–õ–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô (–ò–ó –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ì–û deploy.sh) ---
# Verify domain points to VPS (if domain is provided)
if [ -n "$INPUT_DOMAIN" ]; then
    echo "üåê Verifying domain configuration..."
    DOMAIN_IP=$(dig +short "$INPUT_DOMAIN")
    if [ "$DOMAIN_IP" != "$VPS_IP" ]; then
        echo "‚ùå Error: Domain $INPUT_DOMAIN does not point to VPS IP $VPS_IP"
        echo "Current domain IP: $DOMAIN_IP"
        echo "Please update your DNS A record to point to: $VPS_IP"
        exit 1
    fi
    echo "‚úÖ Domain correctly points to VPS"
fi

# Prepare nginx configuration (if domain is provided)
if [ -n "$INPUT_DOMAIN" ]; then
    echo "üîß Preparing nginx configuration..."
    cp "${ACTION_PATH}/templates/nginx-virtual-host-template" "nginx-virtual-host-${INPUT_DOMAIN}"
    sed -i "s/DOMAIN_NAME/${INPUT_DOMAIN}/g" "nginx-virtual-host-${INPUT_DOMAIN}"
    sed -i "s/PORT/${MAUTIC_PORT}/g" "nginx-virtual-host-${INPUT_DOMAIN}"
fi

# Create deployment environment file
echo "üìã Creating deployment configuration..."

# Create clean deploy.env file
cat > deploy.env << EOF
# Environment variables for deployment
# Generated by GitHub Action

# Required Configuration
EMAIL_ADDRESS=${INPUT_EMAIL}
MAUTIC_PASSWORD=${INPUT_MAUTIC_PASSWORD}
IP_ADDRESS=${VPS_IP}
PORT=${MAUTIC_PORT}
MAUTIC_VERSION=${INPUT_MAUTIC_VERSION}

# Optional Configuration
MAUTIC_THEMES=${INPUT_THEMES}
MAUTIC_PLUGINS=${INPUT_PLUGINS}

# GitHub Token (extracted from plugin/theme URLs if present)
GITHUB_TOKEN=$(echo "${INPUT_PLUGINS}${INPUT_THEMES}" | grep -o 'token=[^&]*' | head -1 | cut -d'=' -f2)

# Database Configuration
MYSQL_DATABASE=${INPUT_MYSQL_DATABASE}
MYSQL_USER=${INPUT_MYSQL_USER}
MYSQL_PASSWORD=${INPUT_MYSQL_PASSWORD}
MYSQL_ROOT_PASSWORD=${INPUT_MYSQL_ROOT_PASSWORD}
EOF

if [ -n "$INPUT_DOMAIN" ]; then
    echo "DOMAIN_NAME=${INPUT_DOMAIN}" >> deploy.env
fi

# Secure the environment file
chmod 600 deploy.env
echo "üîí Environment file secured with restricted permissions"

# Copy templates to current directory for deployment
cp "${ACTION_PATH}/templates/docker-compose.yml" .
cp "${ACTION_PATH}/templates/.mautic_env.template" .

# Compile Deno setup script to binary
echo "üî® Compiling Deno TypeScript setup script to binary..."

# Check if Deno is available
if ! command -v deno &> /dev/null; then
    echo "üì¶ Installing Deno..."
    curl -fsSL https://deno.land/install.sh | sh
    export PATH="$HOME/.deno/bin:$PATH"
fi

echo "‚úÖ Deno version: $(deno --version | head -n 1)"
echo "üîç Target platform: $(uname -m)-$(uname -s)"

mkdir -p build
deno compile --allow-all --target x86_64-unknown-linux-gnu --output ./build/setup "${ACTION_PATH}/scripts/setup.ts"

if [ ! -f "./build/setup" ]; then
    echo "‚ùå Error: Failed to compile Deno setup script"
    exit 1
fi

echo "‚úÖ Successfully compiled setup binary"

echo "üìÅ Files prepared for deployment:"
ls -la deploy.env docker-compose.yml .mautic_env.template build/setup

# Deploy to server
echo "üöÄ Deploying to server..."

# Copy files to server
echo "üì§ Copying files to server..."
ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${VPS_IP} "mkdir -p /var/www"
scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa deploy.env docker-compose.yml .mautic_env.template root@${VPS_IP}:/var/www/
scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa build/setup root@${VPS_IP}:/var/www/setup

# Verify binary can execute
echo "üîç Verifying setup binary on server..."
ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${VPS_IP} "cd /var/www && chmod +x setup && file setup"

# Run setup script
echo "‚öôÔ∏è  Running compiled setup binary on server..."

echo "üîÑ Starting setup script in background and monitoring progress..."
# Start setup script in background, redirecting output to a log file
ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i ~/.ssh/id_rsa root@${VPS_IP} "cd /var/www && nohup ./setup > /var/log/setup-dc.log 2>&1 &"

echo "‚úÖ Setup script started in background"

# Monitor progress
echo "üìä Monitoring setup progress..."
TIMEOUT=900 # 15 minutes
COUNTER=0
SUCCESS=false

while [ $COUNTER -lt $TIMEOUT ]; do
    # Check for success message in log
    if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa root@${VPS_IP} "grep -q 'üéâ Mautic setup completed successfully' /var/log/setup-dc.log 2>/dev/null"; then
        echo "‚úÖ Setup completed successfully!"
        SUCCESS=true
        break
    fi

    # Check for failure message in log
    if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa root@${VPS_IP} "grep -q 'Setup failed:' /var/log/setup-dc.log 2>/dev/null"; then
        echo "‚ùå Setup script reported a failure."
        SUCCESS=false
        break
    fi

    # Check if the process is still running
    if ! ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa root@${VPS_IP} "pgrep -f './setup' > /dev/null 2>&1"; then
        echo "üèÅ Setup process finished. Verifying outcome..."
        # Final check for success message, as it might appear just as the process ends
        if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa root@${VPS_IP} "grep -q 'üéâ Mautic setup completed successfully' /var/log/setup-dc.log 2>/dev/null"; then
            SUCCESS=true
        fi
        break
    fi

    echo "‚è≥ Setup running... (${COUNTER}/${TIMEOUT}s)"
    sleep 30
    COUNTER=$((COUNTER + 30))
done

# Download setup log regardless of outcome
echo "üì• Downloading setup log..."
scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${VPS_IP}:/var/log/setup-dc.log ./setup-dc.log > /dev/null 2>&1 || echo "Could not retrieve log file."

# Final status check
if [ "$SUCCESS" = true ]; then
    echo "üéâ Deployment completed successfully!"
else
    echo "‚ùå Deployment failed or timed out after ${TIMEOUT} seconds."
    echo "üìÑ Displaying last 50 lines from setup-dc.log:"
    tail -n 50 ./setup-dc.log
    exit 1
fi

# Set outputs
echo "üîç Preparing outputs..."
if [ -n "$INPUT_DOMAIN" ]; then
    MAUTIC_URL="https://${INPUT_DOMAIN}"
else
    MAUTIC_URL="http://${VPS_IP}:${MAUTIC_PORT}"
fi

echo "vps-ip=${VPS_IP}" >> $GITHUB_OUTPUT
echo "mautic-url=${MAUTIC_URL}" >> $GITHUB_OUTPUT
echo "deployment-log=./setup-dc.log" >> $GITHUB_OUTPUT

echo "‚úÖ Outputs set successfully"
echo "üåê Your Mautic instance should be available at: ${MAUTIC_URL}"
echo "üìß Admin email: ${INPUT_EMAIL}"
echo "üìä Check the deployment log artifact for detailed information"

